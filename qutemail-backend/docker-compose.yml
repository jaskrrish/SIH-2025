version: '3.8'

services:
  db:
    image: postgres:15-alpine
    container_name: qutemail_db
    environment:
      POSTGRES_DB: qutemail_db
      POSTGRES_USER: qutemail_user
      POSTGRES_PASSWORD: qutemail_pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U qutemail_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: qutemail_redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  celery_worker:
    build: .
    container_name: qutemail_celery_worker
    command: celery -A qutemail worker -l info
    volumes:
      - .:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgresql://qutemail_user:qutemail_pass@db:5432/qutemail_db
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0

  celery_beat:
    build: .
    container_name: qutemail_celery_beat
    command: celery -A qutemail beat -l info
    volumes:
      - .:/app
    depends_on:
      - redis
      - celery_worker
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0

  postfix:
    image: boky/postfix:latest
    container_name: qutemail_postfix
    hostname: mail.qutemail.local
    ports:
      - "25:25"     # SMTP
      - "587:587"   # Submission (authenticated)
      - "465:465"   # SMTPS (legacy)
    volumes:
      - ./config/postfix/main.cf.custom:/etc/postfix/main.cf.d/custom.cf:ro
      - ./config/postfix/master.cf.custom:/etc/postfix/master.cf.d/custom.cf:ro
      - ./config/postfix/virtual_mailbox:/etc/postfix/virtual_mailbox:ro
      - ./config/postfix/virtual_alias:/etc/postfix/virtual_alias:ro
      - postfix_spool:/var/spool/postfix
      - mail_data:/var/mail/vhosts
    environment:
      - ALLOWED_SENDER_DOMAINS=qutemail.local
      - RELAYHOST=
      - POSTFIX_myhostname=mail.qutemail.local
      - POSTFIX_mydomain=qutemail.local
    depends_on:
      - dovecot
      - opendkim
    networks:
      - default
    restart: unless-stopped

  dovecot:
    image: dovecot/dovecot:latest
    container_name: qutemail_dovecot
    hostname: mail.qutemail.local
    ports:
      - "143:143"   # IMAP
      - "993:993"   # IMAPS
      - "24:24"     # LMTP
    volumes:
      - ./config/dovecot/dovecot.conf:/etc/dovecot/dovecot.conf:ro
      - ./config/dovecot/10-auth.conf:/etc/dovecot/conf.d/10-auth.conf:ro
      - ./config/dovecot/10-mail.conf:/etc/dovecot/conf.d/10-mail.conf:ro
      - ./config/dovecot/10-master.conf:/etc/dovecot/conf.d/10-master.conf:ro
      - ./config/dovecot/10-ssl.conf:/etc/dovecot/conf.d/10-ssl.conf:ro
      - ./config/dovecot/20-lmtp.conf:/etc/dovecot/conf.d/20-lmtp.conf:ro
      - ./config/dovecot/users:/etc/dovecot/users:ro
      - mail_data:/var/mail/vhosts
      - postfix_spool:/var/spool/postfix
    environment:
      - DOVECOT_HOSTNAME=mail.qutemail.local
    networks:
      - default
    restart: unless-stopped

  opendkim:
    image: instrumentisto/opendkim:latest
    container_name: qutemail_opendkim
    hostname: opendkim.qutemail.local
    ports:
      - "8891:8891"
    volumes:
      - ./config/opendkim/opendkim.conf:/etc/opendkim/opendkim.conf:ro
      - ./config/opendkim/KeyTable:/etc/opendkim/KeyTable:ro
      - ./config/opendkim/SigningTable:/etc/opendkim/SigningTable:ro
      - ./config/opendkim/TrustedHosts:/etc/opendkim/TrustedHosts:ro
      - ./config/opendkim/keys:/etc/opendkim/keys:ro
    command: opendkim -f
    networks:
      - default
    restart: unless-stopped

volumes:
  postgres_data:
  postfix_spool:
  mail_data:
